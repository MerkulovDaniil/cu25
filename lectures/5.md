---
title: "Условия оптимальности. Функция Лагранжа. Условия Каруша-Куна-Таккера"
author: Даня Меркулов
institute: Оптимизация для всех! ЦУ
format: 
    beamer:
        pdf-engine: xelatex
        aspectratio: 169
        fontsize: 9pt
        section-titles: true
        incremental: true
        include-in-header: ../files/xeheader.tex  # Custom LaTeX commands and preamble
header-includes:
 - \newcommand{\bgimage}{../files/back5.jpeg}
---

:::: {.columns}
::: {.column width="65%"}
> В этой работе нет рисунков. Методы, которые я изложил, не требуют ни конструкций, ни геометрических, ни механических рассуждений: только алгебраические операции, подчиняющиеся регулярному и единообразному правилу процедуры.

Предисловие к аналитической механике
:::

::: {.column width="35%"}
![Жозеф Луи Лагранж](lagrange.jpg)
:::

::::

# Условия оптимальности

## Теория

:::: {.columns}

::: {.column width="40%"}

![Иллюстрация различных стационарных (критических) точек](critical_points.pdf)

:::

::: {.column width="60%"}

$$
f(x) \to \min\limits_{x \in S}
$$

. . .

Множество $S$ обычно называется **бюджетным множеством**.

. . .

Мы говорим, что задача имеет решение, если бюджетное множество **не пусто**: $x^* \in S$, в котором достигается минимум или инфимум данной функции. 

. . .

* Точка $x^*$ является **глобальным минимумом**, если $f(x^*) \leq f(x)$ для всех $x$.
* Точка $x^*$ является **локальным минимумом**, если существует окрестность $N$ точки $x^*$ такая, что $f(x^*) \leq f(x)$ для всех $x \in N$.
* Точка $x^*$ является **строгим локальным минимумом** (также называемым **сильным локальным минимумом**), если существует окрестность $N$ точки $x^*$ такая, что $f(x^*) < f(x)$ для всех $x \in N$ с $x \neq x^*$.
* Мы называем точку $x^*$ **стационарной точкой** (или критической), если $\nabla f(x^*) = 0$. Любой локальный минимум дифференцируемой функции должен быть стационарной точкой.

:::



::::

## Теорема Вейерштрасса о крайних значениях

:::: {.columns}

::: {.column width="40%"}

:::{.callout-theorem}

Пусть $S \subset \mathbb{R}^n$ - компактное множество и $f(x)$ - непрерывная функция на $S$. 
Тогда точка глобального минимума функции $f (x)$ на $S$ существует.
:::

. . .

![Многие практические задачи теоретически разрешимы](goodnews.png)

:::

. . .

::: {.column width="60%"}

:::{.callout-theorem}

## Теорема Тейлора

Пусть $f: \mathbb{R}^n \to \mathbb{R}$ - непрерывно дифференцируемая функция и $p \in \mathbb{R}^n$. Тогда мы имеем:
$$
f(x + p) = f(x) + \nabla f(x + tp)^T p \quad \text{ для некоторого } t \in (0, 1)
$$

. . .

Кроме того, если $f$ дважды непрерывно дифференцируема, то мы имеем:
$$
\nabla f(x + p) = \nabla f(x) + \int_0^1 \nabla^2 f(x + tp)p \, dt
$$  

$$
f(x + p) = f(x) + \nabla f(x)^T p + \frac{1}{2} p^T \nabla^2 f(x + tp) p
$$

для некоторого $t \in (0, 1)$.
:::

:::

::::

# Задачи без ограничений

## Необходимые условия

:::{.callout-theorem}

## Необходимое условие оптимальности первого порядка

Если $x^*$ - локальный минимум и $f$ непрерывно дифференцируема в открытой окрестности, то 
$$
\nabla f(x^*) = 0
$$

. . .

**Доказательство**

Предположим от противного, что $\nabla f(x^*) \neq 0$. Определим вектор $p = -\nabla f(x^*)$ и заметим, что 
$$
p^T \nabla f(x^*) = -\| \nabla f(x^*) \|^2 < 0
$$

. . .

Поскольку $\nabla f$ непрерывна в окрестности $x^*$, существует скаляр $T > 0$ такой, что
$$
p^T \nabla f(x^* + tp) < 0, \text{ for all } t \in [0,T]
$$

. . .

Для любого $\bar{t} \in (0, T]$, мы имеем по теореме Тейлора, что
$$
f(x^* + \bar{t}p) = f(x^*) + \bar{t} p^T \nabla f(x^* + tp), \text{ для некоторого } t \in (0,\bar{t})
$$

. . .

Следовательно, $f(x^* + \bar{t}p) < f(x^*)$ для всех $\bar{t} \in (0, T]$. Мы нашли направление из $x^*$ вдоль которого $f$ убывает, поэтому $x^*$ не является локальным минимумом, что приводит к противоречию.

:::

## Достаточные условия

:::{.callout-theorem}

## Достаточные условия оптимальности второго порядка

Пусть $\nabla^2 f$ непрерывна в открытой окрестности $x^*$ и что
$$
\nabla f(x^*) = 0 \quad \nabla^2 f(x^*) \succ 0.
$$

Тогда $x^*$ является строгим локальным минимумом функции $f$.

. . .

**Доказательство**

Поскольку гессиан непрерывен и положительно определен в $x^*$, мы можем выбрать радиус $r > 0$ такой, что $\nabla^2 f(x)$ остается положительно определенным для всех $x$ в открытом шаре $B = \{ z \mid \|z - x^*\| < r \}$. Возьмем любой ненулевой вектор $p$ с $\|p\| < r$, тогда $x^* + p \in B$ и поэтому

. . .

$$ 
f(x^* + p) = f(x^*) + p^T \nabla f(x^*) + \frac{1}{2} p^T \nabla^2 f(z) p
$$

. . .

$$ 
= f(x^*) + \frac{1}{2} p^T \nabla^2 f(z) p
$$

. . .

где $z = x^* + tp$ для некоторого $t \in (0,1)$. Поскольку $z \in B$, мы имеем $p^T \nabla^2 f(z) p > 0$, и поэтому $f(x^* + p) > f(x^*)$, что дает результат.
:::

## Контрпример Пеано

:::: {.columns}

::: {.column width="45%"}

Заметим, что если $\nabla f(x^*) = 0, \nabla^2 f(x^*) \succeq 0$, т.е. гессиан положительно полуопределен, то мы не можем быть уверены, что $x^*$ является локальным минимумом.

. . .

$$
f(x,y) = (2x^2 - y)(x^2 - y)
$$

. . .

Хотя поверхность не имеет локального минимума в начале координат, ее пересечение с любой вертикальной плоскостью через начало координат (плоскость с уравнением $y=mx$ или $x=0$) является кривой, которая имеет локальный минимум в начале координат. Другими словами, если точка начинает в начале координат $(0,0)$ плоскости и движется от начала координат вдоль любой прямой линии, то значение $(2x^2-y)(x^2 - y)$ будет увеличиваться в начале движения. Тем не менее, $(0,0)$ не является локальным минимумом функции, потому что движение вдоль параболы, такой как $y=\sqrt{2}x^2$, приведет к уменьшению значения функции.
:::

. . .

::: {.column width="55%"}
[![](peano_surface.pdf)](https://fmin.xyz/docs/theory/Optimality.html#unconstrained-optimization)
:::
::::

# Условная оптимизация 

## Общее условие локальной оптимальности первого порядка
:::: {.columns}

::: {.column width="35%"}

Вектор $d \in \mathbb{R}^n$ является допустимым направлением в точке $x^* \in S \subseteq \mathbb{R}^n$, если малые шаги вдоль $d$ не приводят нас за пределы $S$.

. . .

Пусть $S \subseteq \mathbb{R}^n$ и функция $f : \mathbb{R}^n \to \mathbb{R}$. Предположим, что $x^* \in S$ является точкой локального минимума для $f$ над $S$, и дальше предположим, что $f$ непрерывно дифференцируема в окрестности $x^*$.

. . .

1. Тогда для любого допустимого направления $d \in \mathbb{R}^n$ в $x^*$ выполняется $\nabla f(x^*)^\top d \geq 0$.
2. Если, кроме того, $S$ выпукло, то   
   $$
   \nabla f(x^*)^\top(x - x^*) \geq 0, \forall x \in S.
   $$

:::

. . .

::: {.column width="65%"}
![Общее условие локальной оптимальности первого порядка](general_first_order_local_optimality.pdf)
:::
::::

## Выпуклый случай
Следует отметить, что в **выпуклом** случае (т.е., $f(x)$ выпукла) необходимое условие становится достаточным. 

. . .

Еще один важный результат для выпуклого случая звучит следующим образом:Если $f(x): S \to \mathbb{R}$ - выпуклая функция, определенная на выпуклом множестве $S$, то:

. . .

* Любой локальный минимум является глобальным.
* Множество локальных минимумов $S^*$ выпукло.
* Если $f(x)$ - строго или сильно выпуклая функция, то $S^*$ содержит только одну точку $S^* = \{x^*\}$.

## Задачи с ограничениями равенства

В задачах без ограничений все довольно просто и интуитивно. В этом разделе мы добавим одно ограничение равенства, т.е.

. . .

$$
\begin{split}
& f(x) \to \min\limits_{x \in \mathbb{R}^n} \\
\text{s.t. } & h(x) = 0
\end{split}
$$

. . .

Мы попробуем проиллюстрировать подход к решению этой задачи через простой пример с $f(x) = x_1 + x_2$ и $h(x) = x_1^2 + x_2^2 - 2$.

## Задачи с ограничениями равенства

![Иллюстрация ККТ](eq_constr_1.pdf)

## Задачи с ограничениями равенства

![Иллюстрация ККТ](eq_constr_2.pdf)

## Задачи с ограничениями равенства

![Иллюстрация ККТ](eq_constr_3.pdf)

## Задачи с ограничениями равенства

![Иллюстрация ККТ](eq_constr_4.pdf)

## Задачи с ограничениями равенства

![Иллюстрация ККТ](eq_constr_5.pdf)

## Задачи с ограничениями равенства

![Иллюстрация ККТ](eq_constr_6.pdf)

## Задачи с ограничениями равенства

![Иллюстрация ККТ](eq_constr_7.pdf)

## Задачи с ограничениями равенства

![Иллюстрация ККТ](eq_constr_8.pdf)

## Задачи с ограничениями равенства

![Иллюстрация ККТ](eq_constr_9.pdf)

## Задачи с ограничениями равенства

В общем случае: чтобы двигаться от $x_F$ вдоль бюджетного множества к уменьшению функции, мы должны обеспечить два условия:

. . .

$$
\langle \delta x, \nabla h(x_F) \rangle = 0
$$

. . .

$$
\langle \delta x, - \nabla f(x_F) \rangle > 0
$$

. . .

Предположим, что в процессе такого движения мы пришли в точку, где

. . .

$$
-\nabla f(x) = \nu \nabla h(x)
$$

. . .

$$
\langle  \delta x, - \nabla f(x)\rangle = \langle  \delta x, \nu\nabla h(x)\rangle = 0  
$$

. . .

Тогда мы достигли точки бюджетного множества, от которой нельзя будет уменьшить нашу функцию. Это локальный минимум в задаче с ограничениями :)

## Задачи с ограничениями равенства

![Иллюстрация ККТ](eq_constr_10.pdf)

## Лагранжиан

Давайте определим лагранжиан (только для удобства):
$$
L(x, \nu) = f(x) + \nu h(x)
$$

. . .

Если задача *регулярная* (мы определим ее позже) и точка $x^*$ является локальным минимумом для описанной выше задачи, то существует $\nu^*$:

. . .

$$
\begin{split}
\uncover<+->{& \text{Необходимые условия}} \\
\uncover<+->{& \nabla_x L(x^*, \nu^*) = 0 \text{ это мы уже написали выше}}\\
\uncover<+->{& \nabla_\nu L(x^*, \nu^*) = 0 \text{ бюджетное ограничение} }\\
\uncover<+->{& \text{Достаточные условия}}\\
\uncover<+->{& \langle y , \nabla^2_{xx} L(x^*, \nu^*) y \rangle > 0,}\\
\uncover<+->{& \forall y \neq 0 \in \mathbb{R}^n : \nabla h(x^*)^\top y = 0}
\end{split}
$$
Мы должны заметить, что $L(x^*, \nu^*) = f(x^*)$.

## Задачи с ограничениями равенства

$$
\tag{ECP}
\begin{split}
& f(x) \to \min\limits_{x \in \mathbb{R}^n} \\
\text{s.t. } & h_i(x) = 0, \; i = 1,\ldots, p
\end{split}
$$

$$
L(x, \nu) = f(x) + \sum\limits_{i=1}^p\nu_i h_i(x) = f(x) + \nu^\top h(x)
$$
Пусть $f(x)$ и $h_i(x)$ дважды дифференцируемы в точке $x^*$ и непрерывно дифференцируемы в некоторой окрестности $x^*$. Локальные условия минимума для $x \in \mathbb{R}^n, \nu \in \mathbb{R}^p$ записываются как
$$
\begin{split}
& \text{ECP: Necessary conditions} \\
& \nabla_x L(x^*, \nu^*) = 0 \\
& \nabla_\nu L(x^*, \nu^*) = 0 \\
& \text{ECP: Sufficient conditions} \\
& \langle y , \nabla^2_{xx} L(x^*, \nu^*) y \rangle > 0,\\
& \forall y \neq 0 \in \mathbb{R}^n : \nabla h_i(x^*)^\top y = 0
\end{split}
$$

## Задача наименьших квадратов

:::{.callout-example}
Поставим задачу оптимизации и решим ее для линейной системы $Ax = b, A \in \mathbb{R}^{m \times n}$ для трех случаев (предполагая, что матрица имеет полный ранг):

* $m < n$
* $m = n$
* $m > n$
:::

# Задачи с ограничениями неравенства

## Пример задачи с ограничениями неравенства

$$
f(x) = x_1^2 + x_2^2 \;\;\;\; g(x) = x_1^2 + x_2^2 - 1
$$

$$
\begin{split}
& f(x) \to \min\limits_{x \in \mathbb{R}^n} \\
\text{s.t. } & g(x) \leq 0
\end{split}
$$

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_1.pdf)

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_2.pdf)

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_3.pdf)

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_4.pdf)

## Задачи с ограничениями неравенства

Таким образом, если ограничения типа неравенства неактивны в задаче с ограничениями, то не беспокойтесь и напишите решение для задачи без ограничений. Однако это не вся история. Рассмотрим второй простой пример
$$
f(x) = (x_1 - 1)^2 + (x_2 + 1)^2 \;\;\;\; g(x) = x_1^2 + x_2^2 - 1
$$

$$
\begin{split}
& f(x) \to \min\limits_{x \in \mathbb{R}^n} \\
\text{s.t. } & g(x) \leq 0
\end{split}
$$

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_5.pdf)

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_6.pdf)

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_7.pdf)

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_8.pdf)

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_9.pdf)

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_10.pdf)

## Задачи с ограничениями неравенства

![Иллюстрация ККТ (случай неравенства)](ineq_constr_11.pdf)

## Задачи с ограничениями неравенства

Итак, у нас есть задача:
$$
\begin{split}
& f(x) \to \min\limits_{x \in \mathbb{R}^n} \\
\text{s.t. } & g(x) \leq 0
\end{split}
$$
Два возможных случая:

:::: {.columns}

::: {.column width="40%"}
$g(x) \leq 0$ неактивно. $g(x^*) < 0$

* $g(x^*) < 0$
* $\nabla f(x^*) = 0$
* $\nabla^2 f(x^*) > 0$

:::

. . .

::: {.column width="60%"}
$g(x) \leq 0$ активно. $g(x^*) = 0$

* $g(x^*) = 0$
* Необходимые условия: $- \nabla f(x^*) = \lambda \nabla g(x^*)$, $\lambda > 0$
* Достаточные условия: $\langle y, \nabla^2_{xx} L(x^*, \lambda^*) y \rangle > 0, \forall y \neq 0 \in \mathbb{R}^n : \nabla g(x^*)^\top y = 0$
:::

::::

## Лагранжиан для задач с ограничениями неравенства

:::: {.columns}

::: {.column width="35%"}

Объединяя два возможных случая, мы можем записать общие условия для задачи:
$$
\begin{split}
& f(x) \to \min\limits_{x \in \mathbb{R}^n} \\
\text{s.t. } & g(x) \leq 0
\end{split}
$$
Давайте определим функцию Лагранжа:
$$
L(x, \lambda) = f(x) + \lambda g(x)
$$
Классические условия Каруша-Куна-Таккера первого и второго порядка для локального минимума $x^*$, сформулированные при некоторых условиях регулярности, можно записать следующим образом.

:::

. . .

::: {.column width="65%"}

Если $x^*$ является локальным минимумом для описанной выше задачи, то существует единственный множитель Лагранжа $\lambda^*$ такой, что:
$$
\begin{split}
\uncover<+->{& (1) \; \nabla_x L (x^*, \lambda^*) = 0 }\\
\uncover<+->{& (2) \; \lambda^* \geq 0 }\\
\uncover<+->{& (3) \; \lambda^* g(x^*) = 0 }\\
\uncover<+->{& (4) \; g(x^*) \leq 0}\\
% \uncover<+->{& (5) \; \forall y \in C(x^*):  \langle y , \nabla^2_{xx} L(x^*, \lambda^*) y \rangle > 0 }\\
% \uncover<+->{&  \text{where } C(x^*) = \{y \ \in \mathbb{R}^n |  \nabla f(x^*)^\top y \leq 0 \text{ and } \forall i \in I(x^*):  \nabla g_i(x^*)^T y \leq 0 \} \text{ is the critical cone.} }\\
% \uncover<+->{& I(x^*) = \{i \mid g_i(x^*) = 0\}}
\end{split}
$$

:::
::::

## Общая формулировка

$$
\begin{split}
& f_0(x) \to \min\limits_{x \in \mathbb{R}^n}\\
\text{s.t. } & f_i(x) \leq 0, \; i = 1,\ldots,m\\
& h_i(x) = 0, \; i = 1,\ldots, p
\end{split}
$$
Данная формулировка является общей задачей математического программирования. 

Решение включает в себя построение лагранжиана: 
$$
L(x, \lambda, \nu) = f_0(x) + \sum\limits_{i=1}^m \lambda_i f_i(x) + \sum\limits_{i=1}^p\nu_i h_i(x)
$$

## Необходимые условия
Пусть $x^*$, $(\lambda^*, \nu^*)$ является решением математической задачи программирования с нулевым двойственным разрывом (оптимальное значение для исходной задачи $p^*$ равно оптимальному значению для двойственной задачи $d^*$). Пусть также функции $f_0, f_i, h_i$ дифференцируемы.

* $\nabla_x L(x^*, \lambda^*, \nu^*) = 0$
* $\nabla_\nu L(x^*, \lambda^*, \nu^*) = 0$
* $\lambda^*_i \geq 0, i = 1,\ldots,m$
* $\lambda^*_i f_i(x^*) = 0, i = 1,\ldots,m$
* $f_i(x^*) \leq 0, i = 1,\ldots,m$

## Некоторые условия регулярности
Эти условия необходимы для того, чтобы условия Каруша-Куна-Таккера стали необходимыми условиями. Некоторые из них даже превращают необходимые условия в достаточные (например, условие Слейтера). Кроме того, если у нас есть регулярность, мы можем записать необходимые условия второго порядка $\langle y, \nabla^2_{xx} L(x^*, \lambda^*, \nu^*) y \rangle \geq 0$ с *полуопределенным* гессианом лагранжиана.

* **Условие Слейтера.** Если для выпуклой задачи (т.е., предполагая минимизацию, $f_0,f_{i}$ выпуклы и $h_{i}$ аффинны), существует точка $x$ такая, что $h(x)=0$ и $f_{i}(x)<0$ (существование строго допустимой точки), то мы имеем нулевой двойственный разрыв и условия Каруша-Куна-Таккера становятся необходимыми и достаточными.
* **Условие линейной квалификации ограничений.** Если $f_{i}$ и $h_{i}$ являются аффинными функциями, то никаких других условий не требуется.
* **Условие линейной независимости ограничений.** Градиенты активных ограничений неравенства и градиенты ограничений равенства линейно независимы в точке $x^*$.  
* Для других примеров см. [wiki](https://en.wikipedia.org/wiki/Karush%E2%80%93Kuhn%E2%80%93Tucker_conditions#Regularity_conditions_(or_constraint_qualifications)).

## Пример. Проекция на гиперплоскость

$$
\min \frac{1}{2}\|\mathbf{x} - \mathbf{y}\|^2, \quad \text{s.t.} \quad \mathbf{a}^T\mathbf{x} = b.
$$

. . .

**Решение**

Лагранжиан:

. . .

$$
L(\mathbf{x}, \nu) = \frac{1}{2}\|\mathbf{x} - \mathbf{y}\|^2 + \nu(\mathbf{a}^T\mathbf{x} - b)
$$

. . .

Производная $L$ по $\mathbf{x}$:
$$
\frac{\partial L}{\partial \mathbf{x}} = \mathbf{x} - \mathbf{y} + \nu\mathbf{a} = 0, \qquad \mathbf{x} = \mathbf{y} - \nu\mathbf{a}
$$

. . .

$$
\mathbf{a}^T\mathbf{x} = \mathbf{a}^T\mathbf{y} - \nu\mathbf{a}^T\mathbf{a} \qquad \nu = \dfrac{\mathbf{a}^T\mathbf{y} - b}{\|\mathbf{a}\|^2}
$$

. . .

$$
\mathbf{x} = \mathbf{y} - \dfrac{\mathbf{a}^T\mathbf{y} - b}{\|\mathbf{a}\|^2}\mathbf{a}
$$


## Пример. Проекция на симплекс

$$
\min \frac{1}{2} \lVert x - y \rVert^2, \quad \text{s.t.} \quad x^\top 1 = 1, \quad x \geq 0.
$$

. . .

#### Условия ККТ

Лагранжиан задается следующим образом:
$$
L = \frac{1}{2} \lVert x - y \rVert^2 - \sum_i \lambda_i x_i + \nu (x^\top 1 - 1)
$$

. . .

Взяв производную $L$ по $x_i$ и записав ККТ, мы получаем:

* $\frac{\partial L}{\partial x_i} = x_i - y_i - \lambda_i + \nu = 0$
* $\lambda_i x_i = 0$
* $\lambda_i \geq 0$
* $x^\top 1 = 1, \quad x \geq 0$

. . .

::::{.columns}

::: {.column width="50%"}

:::{.callout-question}
Решите приведенные выше условия за $O(n \log n)$.
:::
:::

. . .

::: {.column width="50%"}
:::{.callout-question}
Решите приведенные выше условия за $O(n)$.
:::
:::
::::

## Ссылки
* [Лекция](http://www.csc.kth.se/utbildning/kth/kurser/DD3364/Lectures/KKT.pdf) по условиям ККТ (очень интуитивное объяснение) в курсе "Элементы статистического обучения" @ KTH.
* [Однострочное доказательство ККТ](https://link.springer.com/content/pdf/10.1007%2Fs11590-008-0096-3.pdf)
* [О втором порядке оптимальности для задач оптимизации с ограничениями неравенства](https://www.scirp.org/pdf/OJOp_2013120315191950.pdf)
* [О втором порядке оптимальности в нелинейной оптимизации](https://www.ime.usp.br/~ghaeser/secondorder.pdf)
* [Численная оптимизация](https://www.math.uci.edu/~qnie/Publications/NumericalOptimization.pdf) by Jorge Nocedal and Stephen J. Wright. 