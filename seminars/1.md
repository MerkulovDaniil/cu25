---
title: Вспоминаем линейную алгебру. Скорости сходимости.
author: Семинар
institute: Оптимизация для всех! ЦУ
format: 
   beamer:
      pdf-engine: xelatex
      aspectratio: 169
      fontsize: 9pt
      section-titles: true
      incremental: true
      include-in-header: ../files/xeheader.tex  # Custom LaTeX commands and preamble
   beamer-cu:
      pdf-engine: xelatex
      aspectratio: 169
      fontsize: 9pt
      section-titles: true
      incremental: true
      include-in-header: ../files/xeheader_cu.tex
      header-includes:
        - \newcommand{\cover}{../files/Методы вып_оптимизации_презентация_1.pdf}
---

# Ключевые моменты лекции

## Вспоминаем линейную алгебру

* Наивный matmul $\mathcal{O}(n^3)$, наивный matvec $\mathcal{O}(n^2)$
* Все матрицы имеют SVD
    $$
    A = U \Sigma V^T 
    $$
* $\text{tr} (ABCD) = \text{tr} (DABC) = \text{tr} (CDAB) = \text{tr} (BCDA)$ для любых матриц ABCD, если умножение определено.
* $\langle A, B \rangle = \text{tr}(A^T B)$

## Скорости сходимости

![Иллюстрация различных скоростей сходимости](convergence_rates.pdf){width=200}

* Линейная (геометрическая, экспоненциальная) сходимость: 
    $$
    r_k \leq Cq^k, \quad 0 < q < 1, C > 0
    $$

* Любая сходящаяся последовательность, которая медленнее (быстрее) любой линейно сходящейся последовательности, имеет сублинейную (сверхлинейную) сходимость

* Инфимум всех $0 \le q < 1$ таких, что $r_k \leq Cq^k$ называется \textbf{константой линейной сходимости}, и $q^k$ называется \textbf{скоростью сходимости}.

## Тест корней

Пусть $\{r_k\}_{k=m}^\infty$ - последовательность неотрицательных чисел, сходящаяся к нулю, и пусть 

$$ 
q = \lim_{k \to \infty} \sup_k \; r_k ^{1/k}
$$

* Если $0 \leq q < 1$, то $\{r_k\}_{k=m}^\infty$ имеет линейную сходимость с константой $q$. 
* В частности, если $q = 0$, то $\{r_k\}_{k=m}^\infty$ имеет сверхлинейную сходимость.
* Если $q = 1$, то $\{r_k\}_{k=m}^\infty$ имеет сублинейную сходимость.
* Случай $q > 1$ невозможен.

## Тест отношений

Пусть $\{r_k\}_{k=m}^\infty$ - последовательность строго положительных чисел, сходящаяся к нулю, и пусть

$$
q = \lim_{k \to \infty} \dfrac{r_{k+1}}{r_k}
$$

* Если существует $q$ и $0 \leq q <  1$, то $\{r_k\}_{k=m}^\infty$ имеет линейную сходимость с константой $q$.
* В частности, если $q = 0$, то $\{r_k\}_{k=m}^\infty$ имеет сверхлинейную сходимость.
* Если $q$ не существует, но $q = \lim\limits_{k \to \infty} \sup_k \dfrac{r_{k+1}}{r_k} <  1$, то $\{r_k\}_{k=m}^\infty$ имеет линейную сходимость с константой, не превышающей $q$. 
* Если $\lim\limits_{k \to \infty} \inf_k \dfrac{r_{k+1}}{r_k} =1$, то $\{r_k\}_{k=m}^\infty$ имеет сублинейную сходимость. 
* Случай $\lim\limits_{k \to \infty} \inf_k \dfrac{r_{k+1}}{r_k} > 1$ невозможен. 
* В остальных случаях (т.е., когда $\lim\limits_{k \to \infty} \inf_k \dfrac{r_{k+1}}{r_k} <  1 \leq  \lim\limits_{k \to \infty} \sup_k \dfrac{r_{k+1}}{r_k}$) мы не можем сделать никаких конкретных утверждений о скорости сходимости $\{r_k\}_{k=m}^\infty$.

# Задачи

## Задача 1. Простая, но важная идея о матричных вычислениях.

Предположим, у вас есть следующее выражение

$$
b = A_1 A_2 A_3 x,
$$

где $A_1, A_2, A_3 \in \mathbb{R}^{3 \times 3}$ - случайные квадратные плотные матрицы, и $x \in \mathbb{R}^n$ - вектор. Вам нужно вычислить $b$.

Какой способ лучше всего использовать?

1. $A_1 A_2 A_3 x$ (слева направо)
2. $\left(A_1 \left(A_2 \left(A_3 x\right)\right)\right)$ (справа налево)
3. Не имеет значения
4. Результаты первых двух вариантов не будут одинаковыми.

Проверьте простой [\faPython\ код](https://colab.research.google.com/github/MerkulovDaniil/optim/blob/master/assets/Notebooks/stupid_important_idea_on_mm.ipynb) после вашего интуитивного ответа.

## Задача 2. Связь между Фробениусовой нормой и сингулярными значениями.

Пусть $A \in \mathbb{R}^{m \times n}$, и пусть $q := \min\{m, n\}$. Докажите, что
$$
\|A\|_F^2 = \sum_{i=1}^{q} \sigma_i^2(A) ,
$$

где $\sigma_1(A) \geq \ldots \geq \sigma_q(A) \geq 0$ - сингулярные значения матрицы $A$. Подсказка: используйте связь между Фробениусовой нормой и скалярным произведением и SVD. 

## Задача 3. Знайте свое скалярное произведение.

Упростите следующее выражение:

$$
\sum\limits_{i=1}^n \langle S^{-1} a_i, a_i \rangle,
$$
где $S = \sum\limits_{i=1}^n a_ia_i^T, a_i \in \mathbb{R}^n, \det(S) \neq 0$

## Задача 4. Простые скорости сходимости.

Определите сходимость (и её скорость) или расходимость следующих последовательностей:

* $r_{k} = \frac{1}{3^k}$
* $r_{k} = \frac{4}{3^k}$
* $r_{k} = \frac{1}{k^{10}}$
* $r_{k} = 0.707^k$
* $r_{k} = 0.707^{2^k}$

## Задача 5. Один тест проще, чем другой.

Определите сходимость (и её скорость) или расходимость следующей последовательности:

$$
r_{k} = \frac{1}{k^k}
$$

## Задача 6. Сверхлинейно, но не квадратично.

Покажите, что следующая последовательность не имеет квадратичной сходимости.

$$
r_{k} = \frac{1}{3^{k^2}}
$$

# А где это нужно в реальной жизни?

## LoRA: Low-Rank Adaptation of Large Language Models ([arXiv:2106.09685](https://arxiv.org/pdf/2106.09685))

Поскольку современные LLM слишком большие, чтобы вместиться в память среднего пользователя, мы используем некоторые трюки, чтобы сделать их потребление памяти меньше. Одним из наиболее популярных трюков является LoRA (Low-Rank Adaptation of Large Language Models).

:::: {.columns}
::: {.column width="55%"}
Предположим, у нас есть матрица $W \in \mathbb{R}^{d \times k}$ и мы хотим выполнить следующее обновление:
$$
W = W_0 + \Delta W.
$$
Основная идея LoRA состоит в том, чтобы разложить обновление $\Delta W$ на две низкоранговые матрицы:

\begin{gather*}
W = W_0 + \Delta W = W_0 + BA, \quad B \in \mathbb{R}^{d \times r}, A \in \mathbb{R}^{r \times k}, \\
rank(A) = rank(B) = r \ll \min\{d, k\}.
\end{gather*}

Проверьте [\faPython\ ноутбук](https://colab.research.google.com/github/MerkulovDaniil/hse25/blob/main/notebooks/s1_lora_trump.ipynb) для примера реализации LoRA.

:::

::: {.column width="45%"}
![Иллюстрация LoRA](lora.png){width=100%}
:::
::::

